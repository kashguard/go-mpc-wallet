# MPC 实施方法论（Implementation Methodology）

**版本**: v1.0  
**适用范围**: go-mpc-wallet 项目及其衍生模块  
**最后更新**: 2024-11-28  

---

## 1. 方法论总览

旨在解决的问题：
- 如何将 1700+ 行的详细设计文档转化为可执行、可度量的实施路径
- 如何在协议、安全、性能等多维度交付中保持质量与节奏
- 如何降低复杂度、减少返工并提升团队协作效率

核心理念：
1. **设计驱动开发（Design-Driven Development）**
2. **分阶段里程碑 + 迭代推进**
3. **测试驱动与持续交付**
4. **强安全与高可靠默认**

---

## 2. 分阶段实施模型

```
Baseline -> Phase 1A (协议实现) -> Phase 1B (业务接入) -> Phase 1C (系统交付)
          -> Phase 2 (生产化) -> Phase 3 (高级功能)
```

### 2.1 Phase 1A-1C：MVP阶段

| 阶段 | 时间 | 目标 | 关键产出 |
| --- | --- | --- | --- |
| Phase 1A | W1-W4 | GG18/GG20 协议、DKG、状态机 | 协议代码、状态管理、Bench 报告 |
| Phase 1B | W5-W7 | 上层服务、API、密钥生命周期 | 签名/密钥/Sessions 服务、SDK |
| Phase 1C | W8-W9 | 系统级测试、性能、文档 | E2E 测试、性能优化、MVP包 |

### 2.2 Phase 2：生产化
- 通用阈值（任意 M-of-N）
- 密钥轮换、HA、监控、审计
- 多区域多节点部署

### 2.3 Phase 3：高级功能
- FROST/Schnorr 协议
- 智能合约/AA 集成
- 性能优化（<200ms，1000 TPS）

---

## 3. 设计驱动开发（DDD）

1. **从详细设计导出任务**  
   - 每个功能点拆为 2-5 天的可交付任务
   - 明确输入（设计章节）、输出（代码/文档）、验收标准
2. **接口先行，业务后置**  
   - 先补齐 interface + mock（protocol/key/signing/session）
   - 通过 Wire 注入，避免循环依赖
3. **设计资产共享**  
   - 序列图、状态机、数据流统一放在 `docs/`  
   - 每次实现完成后同步更新设计文档

---

## 4. 测试驱动与质量控制

### 4.1 测试策略

| 层级 | 内容 | 说明 |
| --- | --- | --- |
| 单元测试 | 协议流程、状态机、存储 | 目标覆盖率 ≥ 85% |
| 协议仿真 | 2-of-3 / 3-of-5 DKG & Sign | 引入随机故障、延迟 |
| 集成测试 | API + gRPC + Redis/PG | docker-compose/k3d |
| Chaos 测试 | 节点掉线、网络分区 | 验证容错策略 |
| 性能测试 | Benchmark + Profiling | p95/p99 延迟、TPS |

### 4.2 CI/CD Pipeline

```yaml
name: MPC-CI
on: [push, pull_request]

jobs:
  unit-test:
    steps:
      - run: make test-unit
  integration-test:
    steps:
      - run: make test-integration
  security:
    steps:
      - run: make security-scan
  benchmark:
    steps:
      - run: make benchmark
```

质量门禁（Quality Gates）：
- 单元测试覆盖率 ≥ 85%
- 所有集成测试通过
- gosec/security 扫描无高危
- Benchmark 无性能回退 >5%
- 设计/文档与代码同步更新

---

## 5. 代码审查与协作

### 5.1 审查清单

- **安全**：密钥材料不可出日志/监控，TLS/mTLS 默认启用
- **架构一致性**：遵循分层、Wire 注入、接口命名规范
- **错误处理**：全部使用 `errors.Wrap` 或 `%w`，无忽略错误
- **日志**：使用 `zerolog`，避免敏感信息
- **测试**：新的功能必须附带测试
- **文档**：涉及协议/流程的改动需同步 `docs/`

### 5.2 协作机制

- **结对编程**：协议实现 & 安全相关逻辑必须结对
- **技术例会**：每周一次，更新协议进度、风险
- **设计评审**：重大设计变更需进行评审
- **复盘机制**：故障/缺陷按“事件 -> 原因 -> 改进”记录

---

## 6. 风险管理与应急预案

| 风险 | 描述 | 指标/预警 | 缓解策略 |
| --- | --- | --- | --- |
| 协议复杂度 | GG20/FROST 实现难度 | 单次签名成功率 < 99% | 先跑仿真、降级到GG18 |
| 节点同步 | 网络抖动导致协议失败 | 超时率 > 5% | 增加重试、心跳、Round 检测 |
| 数据一致性 | Redis/PG 双写 | 恢复失败 | WAL + 双阶段提交 |
| 性能不足 | TPS/延迟不达标 | p95 > 800ms | 优化批次、并发、消息压缩 |
| 安全漏洞 | 密钥泄露、注入 | 安全扫描失败 | 审计、最小权限、密钥轮换 |

应急流程：监控预警 → On-call 响应 → 诱因定位 → 回滚/降级 → 复盘文档。

---

## 7. 文档与知识管理

- `docs/mpc-detailed-design.md`：架构/协议/流程唯一事实源
- `docs/mpc-development-plan.md`：开发计划与进度同步更新
- `docs/mpc-implementation-methodology.md`（本文件）：实施原则
- 技术分享、复盘记录统一归档 `docs/retro/`

---

## 8. 快速对表检查

- [ ] 是否从设计导出具体任务
- [ ] 是否明确责任人 / 验收标准
- [ ] 是否已有单元 & 协议仿真测试
- [ ] CI/CD 是否覆盖（测试 + 安全 + 性能）
- [ ] 文档、图谱是否与实现同步
- [ ] 是否完成风险识别与预案

只有全部勾选，才允许进入下一阶段或对外发布。

---

> 📌 提示：本方法论将随着阶段演进持续迭代，任何重大流程/工具/规范的变更，应先在本文件中更新，并在团队同步会上说明。


